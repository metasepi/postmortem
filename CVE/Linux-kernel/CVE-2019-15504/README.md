# CVE-2019-15504 Postmortem

## Summary

drivers/net/wireless/rsi/rsi_91x_usb.c in the Linux kernel through 5.2.9 has a Double Free via crafted USB device traffic (which may be remote via usbip or usbredir).

## Root Causes

The patch caused double free such as following:

```c
static int rsi_init_usb_interface(struct rsi_hw *adapter,
				  struct usb_interface *pfunction)
{
	struct rsi_91x_usbdev *rsi_dev;
	int status;

	rsi_dev = kzalloc(sizeof(*rsi_dev), GFP_KERNEL);
	if (!rsi_dev)
		return -ENOMEM;

	adapter->rsi_dev = rsi_dev;
	rsi_dev->usbdev = interface_to_usbdev(pfunction);
	rsi_dev->priv = (void *)adapter;

	if (rsi_find_bulk_in_and_out_endpoints(pfunction, adapter)) {
		status = -EINVAL;
		goto fail_eps;
	}

	adapter->device = &pfunction->dev;
	usb_set_intfdata(pfunction, adapter);

	rsi_dev->tx_buffer = kmalloc(2048, GFP_KERNEL);
	if (!rsi_dev->tx_buffer) {
		status = -ENOMEM;
		goto fail_eps;
	}

	if (rsi_usb_init_rx(adapter)) {
		rsi_dbg(ERR_ZONE, "Failed to init RX handle\n");
		status = -ENOMEM;
		goto fail_rx;
	}

	rsi_dev->tx_blk_size = 252;
	adapter->block_size = rsi_dev->tx_blk_size;

	/* Initializing function callbacks */
	adapter->check_hw_queue_status = rsi_usb_check_queue_status;
	adapter->determine_event_timeout = rsi_usb_event_timeout;
	adapter->rsi_host_intf = RSI_HOST_INTF_USB;
	adapter->host_intf_ops = &usb_host_intf_ops;

#ifdef CONFIG_RSI_DEBUGFS
	/* In USB, one less than the MAX_DEBUGFS_ENTRIES entries is required */
	adapter->num_debugfs_entries = (MAX_DEBUGFS_ENTRIES - 1);
#endif

	rsi_dbg(INIT_ZONE, "%s: Enabled the interface\n", __func__);
	return 0; // <= Normal case

fail_rx:
	kfree(rsi_dev->tx_buffer);

fail_eps:
	kfree(rsi_dev); // <= Double free. It's freed at `rsi_91x_deinit`

	return status; // <= Error case
```

## Resolution

xxx

## File

drivers/net/wireless/rsi/rsi_91x_usb.c

## Timeline

### 2014-03-16 03:47:02 +0530

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=dad0d04fa7ba41ce603a01e8e64967650303e9a2

The initial code was commited by Fariya Fatima.

### 2018-02-28 13:08:28 +0530

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a1854fae1414dd8edfff4857fd26c3e355d43e19

The `kfree` was injected by Prameela Rani Garnepudi.

### 2019-08-19 18:02:29 -0400

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8b51dc7291473093c821195c4b6af85fadedbc2f

Fixed by Hui Peng.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2019-15504/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2019-15504
