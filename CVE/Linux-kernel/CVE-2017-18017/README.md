# CVE-2017-18017 Postmortem

## Summary

The tcpmss_mangle_packet function in net/netfilter/xt_TCPMSS.c in the Linux kernel before 4.11, and 4.9.x before 4.9.36, allows remote attackers to cause a denial of service (use-after-free and memory corruption) or possibly have unspecified other impact by leveraging the presence of xt_TCPMSS in an iptables action.

## Root Causes

```c
static int
tcpmss_mangle_packet(struct sk_buff *skb,
		     const struct xt_action_param *par,
		     unsigned int family,
		     unsigned int tcphoff,
		     unsigned int minlen)
{
	const struct xt_tcpmss_info *info = par->targinfo;
	struct tcphdr *tcph;
	int len, tcp_hdrlen;
	unsigned int i;
	__be16 oldval;
	u16 newmss;
	u8 *opt;

	/* This is a fragment, no TCP header is available */
	if (par->fragoff != 0)
		return 0;

	if (!skb_make_writable(skb, skb->len))
		return -1;

	len = skb->len - tcphoff;
	if (len < (int)sizeof(struct tcphdr))
		return -1;

	tcph = (struct tcphdr *)(skb_network_header(skb) + tcphoff);
	tcp_hdrlen = tcph->doff * 4; // <= tcph->doff has only 4 bits

	if (len < tcp_hdrlen)
//	if (len < tcp_hdrlen || tcp_hdrlen < sizeof(struct tcphdr)) // <= The patch to fix it
		return -1;
// --snip--
	opt = (u_int8_t *)tcph;
	for (i = sizeof(struct tcphdr); i <= tcp_hdrlen - TCPOLEN_MSS; i += optlen(opt, i)) {
		if (opt[i] == TCPOPT_MSS && opt[i+1] == TCPOLEN_MSS) { // <= Touch head `sizeof(struct tcphdr)` of `tcph`
// --snip--
	/* There is data after the header so the option can't be added
	 * without moving it, and doing so may make the SYN packet
	 * itself too large. Accept the packet unmodified instead.
	 */
	if (len > tcp_hdrlen)
		return 0;

	/* tcph->doff has 4 bits, do not wrap it to 0 */
//	if (tcp_hdrlen >= 15 * 4) // <= The patch to fix it
//		return 0;             // <= Why it returns 0? Why not -1?
```

## Resolution

xxx

## File

* net/netfilter/xt_TCPMSS.c

## Timeline

### 2017-04-08 22:24:19 +0200

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=2638fd0f92d4397884fd991d8f4925cb3f081901

Fixed by Eric Dumazet.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2017-18017/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2017-18017
