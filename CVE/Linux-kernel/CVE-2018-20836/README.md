# CVE-2018-20836 Postmortem

## Summary

An issue was discovered in the Linux kernel before 4.20. There is a race condition in smp_task_timedout() and smp_task_done() in drivers/scsi/libsas/sas_expander.c, leading to a use-after-free.

## Root Causes

```c
static void smp_task_timedout(struct timer_list *t)
{
	struct sas_task_slow *slow = from_timer(slow, t, timer);
	struct sas_task *task = slow->task;
	unsigned long flags;

	spin_lock_irqsave(&task->task_state_lock, flags);
	if (!(task->task_state_flags & SAS_TASK_STATE_DONE)) {
		task->task_state_flags |= SAS_TASK_STATE_ABORTED;
		// complete(&task->slow_task->completion); // <= The patch to fix it
	}
	spin_unlock_irqrestore(&task->task_state_lock, flags);
	
	complete(&task->slow_task->completion); // <= Should complete only on SAS_TASK_STATE_DONE
}

static void smp_task_done(struct sas_task *task)
{
	if (!del_timer(&task->slow_task->timer))
		return; // <= Should complete anytime
	// del_timer(&task->slow_task->timer); // <= The patch to fix it
	complete(&task->slow_task->completion);
}
```

## Resolution

xxx

## File

* drivers/scsi/libsas/sas_expander.c

## Timeline

### 2018-09-25 10:56:54 +0800

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b90cd6f2b905905fb42671009dc0e27c310a16ae

Fixed by Jason Yan.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2018-20836/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2018-20836
