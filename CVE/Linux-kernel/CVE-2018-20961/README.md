# CVE-2018-20961 Postmortem

## Summary

In the Linux kernel before 4.16.4, a double free vulnerability in the f_midi_set_alt function of drivers/usb/gadget/function/f_midi.c in the f_midi driver may allow attackers to cause a denial of service or possibly have unspecified other impact.

## Root Causes

```c
static void
f_midi_complete(struct usb_ep *ep, struct usb_request *req)
{
	struct f_midi *midi = ep->driver_data;
	struct usb_composite_dev *cdev = midi->func.config->cdev;
	int status = req->status;

	switch (status) {
// --snip--
	/* this endpoint is normally active while we're configured */
	case -ECONNABORTED:	/* hardware forced ep reset */
	case -ECONNRESET:	/* request dequeued */
	case -ESHUTDOWN:	/* disconnect from host */
		VDBG(cdev, "%s gone (%d), %d/%d\n", ep->name, status,
				req->actual, req->length);
		if (ep == midi->out_ep) {
			f_midi_handle_out_data(ep, req);
			/* We don't need to free IN requests because it's handled
			 * by the midi->in_req_fifo. */
			free_ep_req(ep, req); // <= first kfree
		}
		return;
// --snip--

static int f_midi_set_alt(struct usb_function *f, unsigned intf, unsigned alt)
{
	struct f_midi *midi = func_to_midi(f);
	unsigned i;
	int err;
// --snip--
		req->complete = f_midi_complete;
		err = usb_ep_queue(midi->out_ep, req, GFP_ATOMIC);
		if (err) {
			ERROR(midi, "%s: couldn't enqueue request: %d\n",
				    midi->out_ep->name, err);
			if (req->buf != NULL) // <= The patch to fix it
				free_ep_req(midi->out_ep, req); // <= second kfree
			return err;
```

## Resolution

xxx

## File

* drivers/usb/gadget/function/f_midi.c
* drivers/usb/gadget/u_f.h

## Timeline

### 2018-03-23 17:00:38 +0000

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7fafcfdf6377b18b2a726ea554d6e593ba44349f

Fixed by Yavuz, Tuba.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2018-20961/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2018-20961
