# CVE-2019-11811 Postmortem

## Summary

An issue was discovered in the Linux kernel before 5.0.4. There is a use-after-free upon attempted read access to /proc/ioports after the ipmi_si module is removed, related to drivers/char/ipmi/ipmi_si_intf.c, drivers/char/ipmi/ipmi_si_mem_io.c, and drivers/char/ipmi/ipmi_si_port_io.c.

## Root Causes

```c
static int try_smi_init(struct smi_info *new_smi)
{
	int rv = 0;
// --snip--
	/* Now that we know the I/O size, we can set up the I/O. */
	rv = new_smi->io.io_setup(&new_smi->io);
// --snip--
// <= Some time to jump `out_err`. It causes use-after-free.
// --snip--
	rv = ipmi_register_smi(&handlers,
			       new_smi,
			       new_smi->io.dev,
			       new_smi->io.slave_addr);
	if (rv) {
		dev_err(new_smi->io.dev,
			"Unable to register device: error %d\n",
			rv);
		goto out_err;
	}
// --snip--
 out_err:
//	if (rv && new_smi->io.io_cleanup) { // <= The patch to fix it
//		new_smi->io.io_cleanup(&new_smi->io);
//		new_smi->io.io_cleanup = NULL;
//	}

	kfree(init_name);
	return rv;
}
```

## Resolution

xxx

## File

* drivers/char/ipmi/ipmi_si_intf.c
* drivers/char/ipmi/ipmi_si_mem_io.c
* drivers/char/ipmi/ipmi_si_port_io.c

## Timeline

### 2017-09-12 23:24:30 -0500

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=58e2763553cb837b879d4a2934094e152e7daf27

Modified by Corey Minyard.

### 2019-01-28 11:08:54 +0800

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=401e7e88d4ef80188ffa07095ac00456f901b8c4

Fixed by Yang Yingliang.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2019-11811/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2019-11811
