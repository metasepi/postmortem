# CVE-2017-7895 Postmortem

## Summary

The NFSv2 and NFSv3 server implementations in the Linux kernel through 4.10.13 lack certain checks for the end of a buffer, which allows remote attackers to trigger pointer-arithmetic errors or possibly have unspecified other impact via crafted requests, related to fs/nfsd/nfs3xdr.c and fs/nfsd/nfsxdr.c.

## Root Causes

```c
int
nfs3svc_decode_writeargs(struct svc_rqst *rqstp, __be32 *p,
					struct nfsd3_writeargs *args)
{
	unsigned int len, v, hdr, dlen;
	u32 max_blocksize = svc_max_payload(rqstp);
	struct kvec *head = rqstp->rq_arg.head;
	struct kvec *tail = rqstp->rq_arg.tail;
// --snip--
//	if ((void *)p > head->iov_base + head->iov_len) // <= The patch to fix it
//		return 0;
// --snip--
	hdr = (void*)p - head->iov_base;
	dlen = head->iov_len + rqstp->rq_arg.page_len + tail->iov_len - hdr;
// --snip--
	rqstp->rq_vec[0].iov_base = (void*)p;
	rqstp->rq_vec[0].iov_len = head->iov_len - hdr; // <= // <= length of `p`
// --snip--

int
nfs3svc_decode_symlinkargs(struct svc_rqst *rqstp, __be32 *p,
					struct nfsd3_symlinkargs *args)
{
	unsigned int len, avail;
	char *old, *new;
	struct kvec *vec;
// --snip--
	old = (char*)p;
	vec = &rqstp->rq_arg.head[0];
//	if ((void *)old > vec->iov_base + vec->iov_len) // <= The patch to fix it
//		return 0;
	avail = vec->iov_len - (old - (char*)vec->iov_base); // <= available of `old`
	while (len && avail && *old) {
		*new++ = *old++;
		len--;
		avail--;
	}
// --snip--

int
nfssvc_decode_writeargs(struct svc_rqst *rqstp, __be32 *p,
					struct nfsd_writeargs *args)
{
	unsigned int len, hdr, dlen;
	struct kvec *head = rqstp->rq_arg.head;
	int v;
// --snip--
	hdr = (void*)p - head->iov_base;
//	if (hdr > head->iov_len) // <= The patch to fix it
//		return 0;
	dlen = head->iov_len + rqstp->rq_arg.page_len - hdr;
// --snip--
	rqstp->rq_vec[0].iov_base = (void*)p;
	rqstp->rq_vec[0].iov_len = head->iov_len - hdr; // <= length of `p`
```

## Resolution

xxx

## File

* fs/nfsd/nfs3xdr.c
* fs/nfsd/nfsxdr.c

## Timeline

### 2017-04-21 15:26:30 -0400

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=13bf9fbff0e5e099e2b6f003a0ab8ae145436309

Fixed by J. Bruce Fields.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2017-7895/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2017-7895
