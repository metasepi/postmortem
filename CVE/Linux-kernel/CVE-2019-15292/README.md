# CVE-2019-15292 Postmortem

## Summary

An issue was discovered in the Linux kernel before 5.0.9. There is a use-after-free in atalk_proc_exit, related to net/appletalk/atalk_proc.c, net/appletalk/ddp.c, and net/appletalk/sysctl_net_atalk.c.

## Root Causes

* The use-after-free occurred in `pde_subdir_find` function.
* It's called by `atalk_proc_exit` function.
* The object was `proc_dir_entry`.

```c
void atalk_register_sysctl(void)
{
	atalk_table_header = register_net_sysctl(&init_net, "net/appletalk", atalk_table); // Should check the return value, because it may fail
}
// --snip--
void __exit atalk_proc_exit(void)
{
	remove_proc_subtree("atalk", init_net.proc_net);
}
// --snip--
int remove_proc_subtree(const char *name, struct proc_dir_entry *parent)
{
	struct proc_dir_entry *root = NULL, *de, *next;
	const char *fn = name;
	unsigned int len;

	write_lock(&proc_subdir_lock);
	if (__xlate_proc_name(name, &parent, &fn) != 0) {
		write_unlock(&proc_subdir_lock);
		return -ENOENT;
	}
	len = strlen(fn);

	root = pde_subdir_find(parent, fn, len);
// --snip--
static struct proc_dir_entry *pde_subdir_find(struct proc_dir_entry *dir,
					      const char *name,
					      unsigned int len)
{
	struct rb_node *node = dir->subdir.rb_node; // <= use-after-free
```

## Resolution

xxx

## File

* include/linux/atalk.h
* net/appletalk/atalk_proc.c
* net/appletalk/ddp.c
* net/appletalk/sysctl_net_atalk.c

## Timeline

### Before the initial git repository

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1da177e4c3f41524e886b7f1b8a0c1fc7321cac2

There are already the bug before introducing git.

### 2019-03-01 10:57:57 +0800

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6377f787aeb945cae7abbb6474798de129e1f3ac

Fixed by YueHaibing.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2019-15292/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2019-15292
