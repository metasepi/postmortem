# CVE-2017-13715 Postmortem

## Summary

The __skb_flow_dissect function in net/core/flow_dissector.c in the Linux kernel before 4.3 does not ensure that n_proto, ip_proto, and thoff are initialized, which allows remote attackers to cause a denial of service (system crash) or possibly execute arbitrary code via a single crafted MPLS packet.

## Root Causes

```c
bool __skb_flow_dissect(const struct sk_buff *skb,
			struct flow_dissector *flow_dissector,
			void *target_container,
			void *data, __be16 proto, int nhoff, int hlen)
{
	struct flow_dissector_key_control *key_control;
	struct flow_dissector_key_basic *key_basic;
	struct flow_dissector_key_addrs *key_addrs;
	struct flow_dissector_key_ports *key_ports;
	struct flow_dissector_key_tags *key_tags;
	struct flow_dissector_key_keyid *key_keyid;
	u8 ip_proto = 0;
//	bool ret = false; // <= The patch to fix it
// --snip--
again:
	switch (proto) {
	case htons(ETH_P_IP): {
		const struct iphdr *iph;
		struct iphdr _iph;
ip:
		iph = __skb_header_pointer(skb, nhoff, sizeof(_iph), data, hlen, &_iph);
		if (!iph || iph->ihl < 5)
			return false; // <= Don't forget to update `n_proto`,`ip_proto`,`thoff`
//			goto out_bad; // <= The patch to fix it
		nhoff += iph->ihl * 4;
// --snip--
out_good:
	ret = true;

out_bad:
	key_basic->n_proto = proto;
	key_basic->ip_proto = ip_proto;
	key_control->thoff = (u16)nhoff;

	return ret;
}
```

## Resolution

xxx

## File

* net/core/flow_dissector.c

## Timeline

### 2015-09-01 09:24:26 -0700

https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a6e544b0a88b53114bfa5a57e21b7be7a8dfc9d0

Fixed by Tom Herbert.

## Supporting information

* CVE: https://www.cvedetails.com/cve/CVE-2017-13715/
* NVD: https://nvd.nist.gov/vuln/detail/CVE-2017-13715
